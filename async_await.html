<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script src="./libs/js/main.js"></script>
<script type="text/javascript">


// 都道府県データ
const prefectureData = [
    {prefCode: 1, prefName: "北海道"},
    {prefCode: 2, prefName: "青森県"},
    {prefCode: 3, prefName: "岩手県"},
    {prefCode: 4, prefName: "宮城県"},
    {prefCode: 5, prefName: "秋田県"},
    {prefCode: 6, prefName: "山形県"},
    {prefCode: 7, prefName: "福島県"},
    {prefCode: 8, prefName: "茨城県"},
    {prefCode: 9, prefName: "栃木県"},
    {prefCode: 10, prefName: "群馬県"},
    {prefCode: 11, prefName: "埼玉県"},
    {prefCode: 12, prefName: "千葉県"},
    {prefCode: 13, prefName: "東京都"},
    {prefCode: 14, prefName: "神奈川県"},
    {prefCode: 15, prefName: "新潟県"},
    {prefCode: 16, prefName: "富山県"},
    {prefCode: 17, prefName: "石川県"},
    {prefCode: 18, prefName: "福井県"},
    {prefCode: 19, prefName: "山梨県"},
    {prefCode: 20, prefName: "長野県"},
    {prefCode: 21, prefName: "岐阜県"},
    {prefCode: 22, prefName: "静岡県"},
    {prefCode: 23, prefName: "愛知県"},
    {prefCode: 24, prefName: "三重県"},
    {prefCode: 25, prefName: "滋賀県"},
    {prefCode: 26, prefName: "京都府"},
    {prefCode: 27, prefName: "大阪府"},
    {prefCode: 28, prefName: "兵庫県"},
    {prefCode: 29, prefName: "奈良県"},
    {prefCode: 30, prefName: "和歌山県"},
    {prefCode: 31, prefName: "鳥取県"},
    {prefCode: 32, prefName: "島根県"},
    {prefCode: 33, prefName: "岡山県"},
    {prefCode: 34, prefName: "広島県"},
    {prefCode: 35, prefName: "山口県"},
    {prefCode: 36, prefName: "徳島県"},
    {prefCode: 37, prefName: "香川県"},
    {prefCode: 38, prefName: "愛媛県"},
    {prefCode: 39, prefName: "高知県"},
    {prefCode: 40, prefName: "福岡県"},
    {prefCode: 41, prefName: "佐賀県"},
    {prefCode: 42, prefName: "長崎県"},
    {prefCode: 43, prefName: "熊本県"},
    {prefCode: 44, prefName: "大分県"},
    {prefCode: 45, prefName: "宮崎県"},
    {prefCode: 46, prefName: "鹿児島県"},
    {prefCode: 47, prefName: "沖縄県"}
];

function getPrefecturesWithTimeout() {
    console.log('3秒後に都道府県データを取得します...');
    
    setTimeout(() => {
        console.log('都道府県一覧:');
        return prefectureData;
    }, 3000);
}

function getPrefecturesPromise() {
    console.log('Promise で3秒後に都道府県データを取得します...');
    
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve(prefectureData);
        }, 3000);
    }).then(data => {
        console.log('都道府県一覧:');
        return data;
    });
}

async function getPref() {
    //文字通りwait=まつ
    //awaitを書かないと取得前に処理が走ってしまう
    let data = await getPrefecturesPromise()
    // またないので、dataがうけとれずエラーになってしまう
    //let data = await getPrefecturesWithTimeout()
    for(var i = 0; i < data.length; i++) {
        if (data[i]['prefName'] == '千葉県') {
            return data[i]['prefCode']
        }
    }
}

(async () => {
   let prefCode = await getPref()
   console.log('awaitの正しい使い方')
   console.log(prefCode)
})();


getPref()
.then((prefCode) =>{
  console.log('promiseを返してきているので、こういう書き方もある')  
  console.log(prefCode)
})



</script>
<body>
  <div style="max-width: 900px; margin: 0 auto; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica', 'Arial', sans-serif; line-height: 1.6;">
    <h1 style="border-bottom: 2px solid #ddd; padding-bottom: 10px;">Async/Await の実践的な使い方</h1>
    
    <p style="background-color: #fff3cd; padding: 10px; border-radius: 5px;">
      <strong>Console</strong>で実行結果を確認してください（3秒後にデータが取得されます）
    </p>

    <h2 style="color: #0366d6; margin-top: 30px;">このサンプルで学べること</h2>
    <ul>
      <li>非同期処理を待機する方法（Promiseとasync/await）</li>
      <li>async関数の正しい使い方</li>
      <li>setTimeout を使った非同期処理のシミュレーション</li>
      <li>async関数はPromiseを返すという性質</li>
    </ul>

    <h2 style="color: #0366d6; margin-top: 30px;">データ構造</h2>
    <p>47都道府県のデータ（prefCode と prefName）</p>
    <pre style="background-color: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto;"><code>prefectureData = [
    {prefCode: 1, prefName: "北海道"},
    {prefCode: 12, prefName: "千葉県"},
    ...
]</code></pre>

    <h2 style="color: #dc3545; margin-top: 30px;">❌ パターン1: setTimeout（間違った例）</h2>
    <pre style="background-color: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto;"><code>function getPrefecturesWithTimeout() {
    setTimeout(() => {
        return prefectureData;  // ❌ これは受け取れない
    }, 3000);
}</code></pre>
    <p><strong>問題点：</strong></p>
    <ul>
      <li>setTimeout のコールバック内の <code>return</code> は関数の戻り値にならない</li>
      <li>非同期処理の結果を受け取れない</li>
      <li>この関数は実質的に <code>undefined</code> を返す</li>
      <li><code>await</code> と組み合わせても正しく動作しない</li>
    </ul>

    <h2 style="color: #28a745; margin-top: 30px;">✅ パターン2: Promise（正しい例）</h2>
    <pre style="background-color: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto;"><code>function getPrefecturesPromise() {
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve(prefectureData);  // ✅ Promiseで結果を返す
        }, 3000);
    }).then(data => {
        console.log('都道府県一覧:');
        return data;
    });
}</code></pre>
    <p><strong>特徴：</strong></p>
    <ul>
      <li><code>Promise</code> を返すため、非同期処理の結果を受け取れる</li>
      <li><code>resolve()</code> で処理の完了を通知</li>
      <li><code>await</code> や <code>.then()</code> で結果を受け取れる</li>
      <li>3秒後にデータが取得される</li>
    </ul>

    <h2 style="color: #0366d6; margin-top: 30px;">パターン3: async/await を使った処理</h2>
    <pre style="background-color: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto;"><code>async function getPref() {
    // awaitで非同期処理の完了を待つ
    let data = await getPrefecturesPromise();
    
    // dataが取得できた後に処理が続く
    for(var i = 0; i < data.length; i++) {
        if (data[i]['prefName'] == '千葉県') {
            return data[i]['prefCode'];  // 12 を返す
        }
    }
}</code></pre>
    <p><strong>重要なポイント：</strong></p>
    <ul>
      <li><code>await</code> を付けることで、データ取得を<strong>待ってから</strong>次の処理に進む</li>
      <li><code>await</code> がないと、データが未取得のまま処理が進んでエラーになる</li>
      <li><code>async</code> 関数内でのみ <code>await</code> を使用できる</li>
      <li>この関数は千葉県のprefCode（12）を返す</li>
    </ul>

    <h2 style="color: #0366d6; margin-top: 30px;">パターン4: 即時実行async関数</h2>
    <pre style="background-color: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto;"><code>(async () => {
    let prefCode = await getPref();
    console.log('awaitの正しい使い方');
    console.log(prefCode);  // 12
})();</code></pre>
    <p><strong>特徴：</strong></p>
    <ul>
      <li>トップレベルで <code>await</code> を使いたい場合に使用</li>
      <li><code>(async () => {...})()</code> の形式で即座に実行</li>
      <li>関数を定義してすぐに実行する</li>
      <li><strong>IIFE（Immediately Invoked Function Expression）</strong>パターン</li>
    </ul>

    <h2 style="color: #0366d6; margin-top: 30px;">パターン5: async関数をPromiseとして使う</h2>
    <pre style="background-color: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto;"><code>getPref()
.then((prefCode) => {
    console.log('promiseを返してきているので、こういう書き方もある');
    console.log(prefCode);  // 12
})</code></pre>
    <p><strong>重要な性質：</strong></p>
    <ul>
      <li><code>async</code> 関数は<strong>必ずPromiseを返す</strong></li>
      <li>そのため <code>.then()</code> や <code>.catch()</code> が使える</li>
      <li><code>await</code> でも <code>.then()</code> でも同じ結果が得られる</li>
      <li>用途に応じて使い分けられる</li>
    </ul>

    <h2 style="color: #0366d6; margin-top: 30px;">処理の流れ</h2>
    <ol>
      <li><strong>getPrefecturesPromise()</strong> を呼び出し</li>
      <li>3秒間待機（setTimeoutで非同期処理をシミュレート）</li>
      <li>都道府県データが返される</li>
      <li><strong>getPref()</strong> でデータから千葉県を検索</li>
      <li>千葉県のprefCode（12）を返す</li>
      <li>2つの方法で結果を表示：
        <ul>
          <li>即時実行async関数で <code>await</code> を使用</li>
          <li><code>.then()</code> を使用</li>
        </ul>
      </li>
    </ol>

    <h2 style="color: #0366d6; margin-top: 30px;">まとめ</h2>
    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
      <thead>
        <tr style="background-color: #f6f8fa;">
          <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">パターン</th>
          <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">結果</th>
          <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">評価</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="border: 1px solid #ddd; padding: 10px;"><code>setTimeout</code> のみ</td>
          <td style="border: 1px solid #ddd; padding: 10px;">データを受け取れない</td>
          <td style="border: 1px solid #ddd; padding: 10px;">❌ 間違い</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 10px;"><code>Promise</code></td>
          <td style="border: 1px solid #ddd; padding: 10px;">データを正しく返せる</td>
          <td style="border: 1px solid #ddd; padding: 10px;">✅ 正しい</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 10px;"><code>async/await</code></td>
          <td style="border: 1px solid #ddd; padding: 10px;">同期処理のように書ける</td>
          <td style="border: 1px solid #ddd; padding: 10px;">✅ 推奨</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 10px;"><code>async().then()</code></td>
          <td style="border: 1px solid #ddd; padding: 10px;">Promiseとして扱える</td>
          <td style="border: 1px solid #ddd; padding: 10px;">✅ 柔軟</td>
        </tr>
      </tbody>
    </table>

    <p style="margin-top: 20px; padding: 15px; background-color: #e7f3ff; border-left: 4px solid #0366d6; border-radius: 4px;">
      <strong>💡 ポイント：</strong><br>
      • 非同期処理には必ず <code>Promise</code> を使う<br>
      • <code>await</code> を忘れると、データが未取得のまま処理が進む<br>
      • <code>async</code> 関数は常に <code>Promise</code> を返す<br>
      • 実際のAPI呼び出しでも同じパターンが使える
    </p>

    <div id="pref_area"></div>
    <div id="city_area"></div>
  </div>
</body>
</html>
